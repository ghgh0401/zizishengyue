<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仔仔艺考声乐助手 - 曲目库</title>
    <script>
        // 确保页面在正确的协议和端口打开
        if (window.location.protocol !== 'http:' || window.location.port !== '3004') {
            console.log('检测到错误的协议或端口，正在重定向到正确的URL...');
            const path = window.location.pathname.split('/').pop();
            window.location.href = `http://localhost:3004/${path}`;
        }
    </script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        // 环境变量配置 - 在浏览器中模拟NODE_ENV
        const IS_DEVELOPMENT = true; // 开发环境设为true，生产环境设为false
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',  // 蓝色主题
                        secondary: '#3b82f6',
                        accent: '#60a5fa',
                        dark: '#1e3a8a',
                        light: '#bfdbfe',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .btn-primary {
                @apply bg-primary text-white font-medium px-6 py-3 rounded-lg transition duration-300 hover:bg-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary;
            }
            .btn-secondary {
                @apply bg-white text-primary font-medium px-6 py-3 rounded-lg border border-primary transition duration-300 hover:bg-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary;
            }
            .nav-item {
                @apply px-4 py-2 text-gray-300 hover:text-white transition duration-200;
            }
            .nav-item-active {
                @apply px-4 py-2 text-white border-b-2 border-white font-medium;
            }
            .filter-btn {
                @apply px-4 py-2 rounded-full transition duration-200;
            }
            .filter-btn-active {
                @apply bg-primary text-white;
            }
            .filter-btn-inactive {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 导航栏 -->
    <header class="bg-primary shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-music text-2xl text-white"></i>
                <span class="text-xl font-bold text-white">仔仔艺考声乐助手</span>
            </div>
            <nav class="hidden md:flex space-x-1">
                <a href="index.html" class="nav-item">首页</a>
                <a href="song-library.html" class="nav-item-active">曲目库</a>
                <a href="strategy.html" class="nav-item">备考攻略</a>
                <a href="user-center.html" class="nav-item">个人中心</a>
                <a href="admin.html" class="nav-item">后台管理</a>
            </nav>

            <!-- 移动端菜单按钮 -->
            <button class="md:hidden text-white text-xl" id="mobile-menu-button">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div class="md:hidden hidden" id="mobile-menu">
            <a href="index.html" class="block px-4 py-2 bg-primary text-gray-300 hover:text-white border-b border-gray-700">首页</a>
            <a href="song-library.html" class="block px-4 py-2 bg-primary text-white border-b border-gray-700">曲目库</a>
            <a href="strategy.html" class="block px-4 py-2 bg-primary text-gray-300 hover:text-white border-b border-gray-700">备考攻略</a>
            <a href="admin.html" class="block px-4 py-2 bg-primary text-gray-300 hover:text-white">后台管理</a>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <section class="relative rounded-2xl overflow-hidden mb-12 bg-gradient-to-r from-primary to-dark">
            <div class="absolute inset-0 opacity-20">
                <img src="https://picsum.photos/id/1083/1200/300" alt="音乐背景" class="w-full h-full object-cover" />
            </div>
            <div class="relative py-12 px-8 text-center text-white z-10">
                <h1 class="text-3xl md:text-4xl font-bold mb-3 text-shadow">声乐曲目库</h1>
                <p class="text-lg max-w-3xl mx-auto">专业的声乐曲目收录，帮助你找到适合自己的练习和考试曲目</p>
            </div>
        </section>

        <!-- 搜索和筛选 -->
        <section class="mb-8">
            <!-- 搜索框 -->
            <div class="mb-6 relative">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="搜索曲目或作曲家..." 
                    class="w-full pl-12 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition duration-300"
                />
                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- 分类筛选 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">曲目分类</h3>
                
                <!-- 第一栏：声部 -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-600 mb-2">声部</h4>
                    <div class="flex flex-wrap gap-2" id="voice-part-filters">
                        <button class="filter-btn filter-btn-active" data-type="all">全部声部</button>
                        <button class="filter-btn filter-btn-inactive" data-type="男声">男声</button>
                        <button class="filter-btn filter-btn-inactive" data-type="女声">女声</button>
                    </div>
                </div>
                
                <!-- 第二栏：语言 -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-600 mb-2">语言</h4>
                    <div class="flex flex-wrap gap-2" id="language-filters">
                        <button class="filter-btn filter-btn-active" data-type="all">全部语言</button>
                        <button class="filter-btn filter-btn-inactive" data-type="中文">中文</button>
                        <button class="filter-btn filter-btn-inactive" data-type="外文">外文</button>
                        <button class="filter-btn filter-btn-inactive" data-type="其他">其他</button>
                    </div>
                </div>
                
                <!-- 第三栏：体裁 -->
                <div>
                    <h4 class="text-md font-medium text-gray-600 mb-2">体裁</h4>
                    <div class="flex flex-wrap gap-2" id="genre-filters">
                        <button class="filter-btn filter-btn-active" data-type="all">全部体裁</button>
                        <button class="filter-btn filter-btn-inactive" data-type="古诗词">古诗词</button>
                        <button class="filter-btn filter-btn-inactive" data-type="民歌">民歌</button>
                        <button class="filter-btn filter-btn-inactive" data-type="艺术歌曲">艺术歌曲</button>
                        <button class="filter-btn filter-btn-inactive" data-type="歌剧选段">歌剧选段</button>
                        <button class="filter-btn filter-btn-inactive" data-type="流行歌曲">流行歌曲</button>
                    </div>
                </div>
                
                <!-- 隐藏的类型筛选器，用于JavaScript操作 -->
                <div id="type-filters" class="hidden">
                    <button class="filter-btn filter-btn-active" data-type="all">全部</button>
                </div>
            </div>

            <!-- 难度筛选 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">难度级别</h3>
                <div class="flex flex-wrap gap-2" id="difficulty-filters">
                    <button class="filter-btn filter-btn-active" data-difficulty="">全部</button>
                    <button class="filter-btn filter-btn-inactive" data-difficulty="1">
                        <i class="fa fa-star text-yellow-400"></i> 初级
                    </button>
                    <button class="filter-btn filter-btn-inactive" data-difficulty="2">
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i> 中级
                    </button>
                    <button class="filter-btn filter-btn-inactive" data-difficulty="3">
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i> 高级
                    </button>
                    <button class="filter-btn filter-btn-inactive" data-difficulty="4">
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i> 专业级
                    </button>
                    <button class="filter-btn filter-btn-inactive" data-difficulty="5">
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i>
                        <i class="fa fa-star text-yellow-400"></i> 大师级
                    </button>
                </div>
            </div>
        </section>

        <!-- 曲目列表 -->
        <section class="mb-12">
            <!-- 结果统计 -->
            <div class="flex justify-between items-center mb-6">
                <div class="text-gray-600" id="result-count">显示: 1-12，共 86 首曲目</div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-600">排序:</span>
                    <select id="sort-select" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="newest">最新添加</option>
                        <option value="popular">最受欢迎</option>
                        <option value="title">按标题</option>
                    </select>
                </div>
            </div>

            <!-- 曲目网格 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="songs-container">
                <!-- 加载动画 -->
                <div class="flex justify-center items-center col-span-full h-64">
                    <i class="fa fa-circle-o-notch fa-spin text-3xl text-primary"></i>
                </div>
            </div>

            <!-- 分页 -->
            <div class="flex justify-center mt-12" id="pagination">
                <!-- 分页控件将通过JavaScript动态生成 -->
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-primary text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">关于我们</h3>
                    <p class="mb-4 text-gray-300">仔仔艺考声乐助手致力于为艺考生提供专业、全面的声乐学习资源和服务，帮助每一位艺考生实现自己的艺术梦想。</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-white hover:text-gray-300 transition duration-200"><i class="fa fa-weibo text-xl"></i></a>
                        <a href="#" class="text-white hover:text-gray-300 transition duration-200"><i class="fa fa-wechat text-xl"></i></a>
                        <a href="#" class="text-white hover:text-gray-300 transition duration-200"><i class="fa fa-qq text-xl"></i></a>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">快速链接</h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-300 hover:text-white transition duration-200">首页</a></li>
                        <li><a href="song-library.html" class="text-gray-300 hover:text-white transition duration-200">曲目库</a></li>
                        <li><a href="strategy.html" class="text-gray-300 hover:text-white transition duration-200">学习攻略</a></li>
                        <li><a href="video.html" class="text-gray-300 hover:text-white transition duration-200">视频教学</a></li>
                        <li><a href="user-center.html" class="text-gray-300 hover:text-white transition duration-200">个人中心</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">联系我们</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fa fa-envelope-o mt-1 mr-3"></i>
                            <span class="text-gray-300">contact@zaizaiyikao.com</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-phone mr-3"></i>
                            <span class="text-gray-300">400-123-4567</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-map-marker mt-1 mr-3"></i>
                            <span class="text-gray-300">北京市海淀区中关村南大街5号</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>© 2023 仔仔艺考声乐助手 版权所有 | ICP备案号:12345678号</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 移动端菜单切换
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // 筛选状态管理 - 设置为window属性，供performance-optimization.js访问
        window.filterState = {
            voicePart: 'all',  // 声部筛选
            language: 'all',   // 语言筛选
            genre: 'all',      // 体裁筛选
            difficulty: '',
            search: '',
            sort: 'newest',
            page: 1,
            pageSize: 12
        };

        // 初始化筛选按钮事件
        function initFilterButtons() {
            // 初始化所有筛选栏的通用处理函数
            function setupFilterButtons(containerId, filterKey) {
                document.querySelectorAll(`#${containerId} button`).forEach(button => {
                    button.addEventListener('click', function() {
                        // 更新当前栏目内的按钮状态
                        document.querySelectorAll(`#${containerId} button`).forEach(btn => {
                            btn.classList.remove('filter-btn-active', 'filter-btn-inactive');
                            btn.classList.add('filter-btn-inactive');
                        });
                        this.classList.remove('filter-btn-inactive');
                        this.classList.add('filter-btn-active');
                        
                        // 更新对应分类的筛选状态并重新加载
                        window.filterState[filterKey] = this.dataset.type;
                        window.filterState.page = 1;
                        loadSongs();
                    });
                });
            }
            
            // 设置三个分类栏的筛选按钮事件，分别对应不同的筛选状态键
            setupFilterButtons('voice-part-filters', 'voicePart');
            setupFilterButtons('language-filters', 'language');
            setupFilterButtons('genre-filters', 'genre');

            // 难度筛选按钮
            document.querySelectorAll('#difficulty-filters button').forEach(button => {
                button.addEventListener('click', function() {
                    // 更新UI
                    document.querySelectorAll('#difficulty-filters button').forEach(btn => {
                        btn.classList.remove('filter-btn-active', 'filter-btn-inactive');
                        btn.classList.add('filter-btn-inactive');
                    });
                    this.classList.remove('filter-btn-inactive');
                    this.classList.add('filter-btn-active');
                    
                    // 更新筛选状态并重新加载
                    window.filterState.difficulty = this.dataset.difficulty;
                    window.filterState.page = 1;
                    loadSongs();
                });
            });

            // 搜索框
            document.getElementById('search-input').addEventListener('input', function() {
                window.filterState.search = this.value;
                window.filterState.page = 1;
                
                // 防抖处理
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    loadSongs();
                }, 500);
            });

            // 排序选择
            document.getElementById('sort-select').addEventListener('change', function() {
                window.filterState.sort = this.value;
                loadSongs();
            });
        }

        // 生成难度星星
        function generateDifficultyStars(difficulty) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= difficulty) {
                    stars += '<i class="fa fa-star text-yellow-400"></i>';
                } else {
                    stars += '<i class="fa fa-star-o text-gray-300"></i>';
                }
            }
            return stars;
        }

        // 生成分页控件
        function renderPagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            // 上一页按钮
            const prevButton = document.createElement('button');
            prevButton.className = `px-4 py-2 rounded-lg mx-1 ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary border border-primary hover:bg-light'}`;
            prevButton.innerHTML = '<i class="fa fa-angle-left"></i> 上一页';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    window.filterState.page = currentPage - 1;
                    loadSongs();
                }
            });
            paginationContainer.appendChild(prevButton);

            // 页码按钮
            const showPages = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    showPages.push(i);
                }
            } else {
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        showPages.push(i);
                    }
                    showPages.push('...', totalPages);
                } else if (currentPage >= totalPages - 3) {
                    showPages.push(1, '...');
                    for (let i = totalPages - 4; i <= totalPages; i++) {
                        showPages.push(i);
                    }
                } else {
                    showPages.push(1, '...');
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        showPages.push(i);
                    }
                    showPages.push('...', totalPages);
                }
            }

            showPages.forEach(page => {
                if (page === '...') {
                    const dots = document.createElement('span');
                    dots.className = 'px-4 py-2 text-gray-500';
                    dots.textContent = '...';
                    paginationContainer.appendChild(dots);
                } else {
                    const pageButton = document.createElement('button');
                    pageButton.className = `px-4 py-2 rounded-lg mx-1 ${page === currentPage ? 'bg-primary text-white' : 'bg-white text-primary border border-primary hover:bg-light'}`;
                    pageButton.textContent = page;
                    pageButton.addEventListener('click', () => {
                        window.filterState.page = page;
                        loadSongs();
                    });
                    paginationContainer.appendChild(pageButton);
                }
            });

            // 下一页按钮
            const nextButton = document.createElement('button');
            nextButton.className = `px-4 py-2 rounded-lg mx-1 ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary border border-primary hover:bg-light'}`;
            nextButton.innerHTML = '下一页 <i class="fa fa-angle-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    window.filterState.page = currentPage + 1;
                    loadSongs();
                }
            });
            paginationContainer.appendChild(nextButton);
        }

        // 加载曲目列表
        async function loadSongs() {
            try {
                // 添加更多调试信息
                console.log('===== loadSongs函数开始执行 =====');
                console.log('当前window.filterState:', JSON.stringify(window.filterState, null, 2));
                console.log('document.domain:', document.domain);
                console.log('window.location.protocol:', window.location.protocol);
                console.log('window.location.hostname:', window.location.hostname);
                console.log('window.location.port:', window.location.port);
                console.log('navigator.userAgent:', navigator.userAgent);
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log('开始加载曲目数据，参数:', filterState);
                }
                
                // 显示加载状态
                const songsContainer = document.getElementById('songs-container');
                songsContainer.innerHTML = '<div class="flex justify-center items-center col-span-full h-64"><i class="fa fa-circle-o-notch fa-spin text-3xl text-primary"></i></div>';

                // 使用明确的服务器地址，避免直接从文件系统访问时的问题
                // 使用与服务器相同的端口
    const port = window.location.port || '3004';
    const baseUrl = `http://localhost:${port}`;
                let url = `${baseUrl}/api/songs?page=${window.filterState.page}&pageSize=${window.filterState.pageSize}`;
                
                if (window.filterState.search) {
                    url += `&search=${encodeURIComponent(window.filterState.search)}`;
                }
                
                // 添加三个分类的筛选条件
                if (window.filterState.voicePart !== 'all') {
                    url += `&voicePart=${encodeURIComponent(window.filterState.voicePart)}`;
                }
                if (window.filterState.language !== 'all') {
                    url += `&language=${encodeURIComponent(window.filterState.language)}`;
                }
                if (window.filterState.genre !== 'all') {
                    url += `&genre=${encodeURIComponent(window.filterState.genre)}`;
                }
                
                if (window.filterState.difficulty) {
                    url += `&difficulty=${window.filterState.difficulty}`;
                }
                
                if (window.filterState.sort) {
                    url += `&sort=${window.filterState.sort}`;
                }

                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log('API请求URL:', url);
                }
                
                // 添加更多调试信息
                console.log('===== 准备发送API请求 =====');
                console.log('构建的完整URL:', url);
                console.log('当前时间:', new Date().toISOString());
                console.log('navigator.onLine:', navigator.onLine);
                
                // 设置请求超时（10秒）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('请求超时，准备中止...');
                    controller.abort();
                }, 10000);
                
                // 发送请求
                console.log('===== 开始发送fetch请求 =====');
                const response = await fetch(url, {
                    signal: controller.signal,
                    credentials: 'include'
                }).catch(fetchError => {
                    console.error('===== fetch请求失败 =====', fetchError);
                    console.error('错误名称:', fetchError.name);
                    console.error('错误消息:', fetchError.message);
                    console.error('错误栈:', fetchError.stack);
                    clearTimeout(timeoutId); // 确保清除超时计时器
                    throw fetchError; // 重新抛出错误，让外部try-catch处理
                });
                
                console.log('===== fetch请求成功返回 =====');
                clearTimeout(timeoutId); // 清除超时计时器
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log('API响应状态:', response.status);
                    console.log('API响应头:', Object.fromEntries(response.headers.entries()));
                }
                
                if (!response.ok) {
                    console.error('===== HTTP响应错误 =====', response.status, response.statusText);
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                // 尝试获取原始响应文本
                const responseText = await response.clone().text();
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log('原始响应文本:', responseText);
                }
                
                // 解析JSON
                const data = await response.json();
                
                // 修复：处理API返回的数据格式，将type、type2、type3映射到genre、language、voicePart
                if (data.success && data.data && data.data.items) {
                    // 遍历所有曲目，添加缺失的字段或映射字段
                    data.data.items = data.data.items.map(song => {
                        // 如果song是字符串，尝试解析为对象
                        if (typeof song === 'string') {
                            try {
                                song = JSON.parse(song);
                            } catch (e) {
                                console.warn('解析歌曲数据失败:', e, song);
                            }
                        }
                        
                        // 确保song是对象
                        if (typeof song !== 'object' || song === null) {
                            song = {};
                        }
                        
                        // 处理tags字段（如果是字符串形式的数组）
                        if (typeof song.tags === 'string') {
                            try {
                                song.tags = JSON.parse(song.tags);
                            } catch (e) {
                                song.tags = [];
                            }
                        } else if (!Array.isArray(song.tags)) {
                            song.tags = [];
                        }
                        
                        // 映射字段：将type、type2、type3映射到genre、language、voicePart
                        // 这里需要根据API返回的实际数据格式进行调整
                        // 根据测试结果，我们观察到的映射关系:
                        // type -> genre (艺术歌曲、男声)
                        // type2 -> language (中文、男声)
                        // type3 -> voicePart (中文、歌剧选段)
                        
                        // 确保必要字段存在
                        song.genre = song.genre || song.type || '未知体裁';
                        song.language = song.language || song.type2 || song.type3 || '未知语言';
                        song.voicePart = song.voicePart || song.type2 || song.type || '未知声部';
                        
                        // 确保difficulty是数字
                        if (song.difficulty === undefined || song.difficulty === null) {
                            song.difficulty = 3; // 默认中等难度
                        } else if (typeof song.difficulty !== 'number') {
                            song.difficulty = parseInt(song.difficulty) || 3;
                        }
                        
                        // 确保id存在
                        song.id = song.id || Math.random().toString(36).substr(2, 9);
                        
                        // 确保views存在
                        song.views = song.views || 0;
                        
                        // 确保imageUrl存在
                        song.imageUrl = song.imageUrl || 'https://via.placeholder.com/400x300?text=音乐';
                        
                        // 确保title存在
                        song.title = song.title || '未知曲目';
                        
                        // 确保composer存在
                        song.composer = song.composer || '未知作曲家';
                        
                        return song;
                    });
                }
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log('API响应数据:', data);
                    
                    // 数据结构检查
                    console.log('数据结构详细检查:');
                    console.log('- data是否存在:', typeof data !== 'undefined');
                    console.log('- data类型:', typeof data);
                    console.log('- success字段是否存在:', 'success' in data);
                    console.log('- success值:', data.success);
                    console.log('- data字段是否存在:', 'data' in data);
                    console.log('- data.data类型:', data.data && typeof data.data);
                    console.log('- data.data.items是否存在:', data.data && 'items' in data.data);
                    console.log('- data.data.items是否为数组:', data.data && data.data.items && Array.isArray(data.data.items));
                    console.log('- data.data.items长度:', data.data && data.data.items ? data.data.items.length : 'undefined');
                    console.log('- data.data.totalItems字段是否存在:', data.data && 'totalItems' in data.data);
                    console.log('- data.data.totalItems值:', data.data && data.data.totalItems);
                }

                if (data.success) {
                    // 更新曲目列表
                    songsContainer.innerHTML = '';
                    
                    // 检查数据结构
                    if (!data.data || !data.data.items || !Array.isArray(data.data.items)) {
                        console.error('数据结构错误，缺少有效的data.items数组:', data);
                        songsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-full py-12">数据格式错误，请稍后再试</div>';
                        return;
                    }
                    
                    if (data.data.items.length === 0) {
                        songsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-full py-12">没有找到符合条件的曲目</div>';
                    } else {
                        try {
                            data.data.items.forEach(song => {
                                const songCard = document.createElement('div');
                                songCard.className = 'bg-white rounded-xl shadow-md overflow-hidden card-hover group';

                                songCard.innerHTML = `
                                    <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover group border border-gray-200/50 relative" style="font-family: 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', sans-serif;">
                                        <!-- 闪光动画效果 -->
                                        <div class="shine-animation absolute top-0 left-[-100%] w-1/2 h-full bg-gradient-to-r from-transparent via-white/10 to-transparent skew-x-[-25deg] transition-all duration-700 ease-out"></div>
                                           
                                        <div class="relative overflow-hidden h-72 bg-gradient-to-br from-gray-200 to-gray-100">
                                            <img src="${song.imageUrl || 'https://via.placeholder.com/400x300?text=音乐'}" alt="${song.title}" class="w-full h-full object-cover transition-transform duration-600 ease-out group-hover:scale-108" />
                                            <!-- 多标签显示区域 -->
                                            <div class="absolute top-2 right-2 flex flex-col items-end gap-1.5">
                                                <!-- 显示最多三个标签 -->
                                                ${Array.isArray(song.tags) && song.tags.length > 0 ? 
                                                    song.tags.slice(0, 3).map(tag => `
                                                        <div class="bg-primary/80 text-white text-xs px-2 py-1 rounded-md shadow-sm">${tag}</div>
                                                    `).join('') : 
                                                    (function() {
                                                        // 提供默认标签以确保始终显示标签
                                                        let defaultTags = [];
                                                        if (song.type) defaultTags.push(`<div class="bg-primary/80 text-white text-xs px-2 py-1 rounded-md shadow-sm">${song.type}</div>`);
                                                        if (song.type2) defaultTags.push(`<div class="bg-primary/70 text-white text-xs px-2 py-1 rounded-md shadow-sm">${song.type2}</div>`);
                                                        if (song.type3) defaultTags.push(`<div class="bg-primary/60 text-white text-xs px-2 py-1 rounded-md shadow-sm">${song.type3}</div>`);
                                                        
                                                        // 如果没有任何标签数据，提供默认标签
                                                        if (defaultTags.length === 0) {
                                                            defaultTags = [
                                                                `<div class="bg-primary/80 text-white text-xs px-2 py-1 rounded-md shadow-sm">${song.genre || '未知体裁'}</div>`,
                                                                `<div class="bg-primary/70 text-white text-xs px-2 py-1 rounded-md shadow-sm">${song.language || '未知语言'}</div>`,
                                                                `<div class="bg-primary/60 text-white text-xs px-2 py-1 rounded-md shadow-sm">难度${song.difficulty || 3}</div>`
                                                            ];
                                                        }
                                                        
                                                        return defaultTags.join('');
                                                    })()
                                                }
                                            </div>
                                            <!-- 收藏按钮 - 移到最顶层 -->
                                            <button class="favorite-btn absolute top-2 left-2 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow-md transition-all duration-300 hover:bg-white hover:scale-110 z-20" data-song-id="${song.id}">
                                                <i class="fa fa-heart-o text-primary text-sm"></i>
                                            </button>
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                                <a href="song-detail.html?id=${song.id}" class="bg-white/90 text-primary rounded-full w-14 h-14 flex items-center justify-center transform translate-y-4 group-hover:translate-y-0 transition-all duration-300 shadow-lg hover:bg-primary hover:text-white hover:scale-110 relative overflow-hidden">
                                                    <i class="fa fa-play text-lg z-10"></i>
                                                    <span class="absolute inset-0 bg-primary opacity-0 group-hover:opacity-20 transition-opacity duration-300"></span>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="p-5 flex flex-col flex-grow">
                                            <h3 class="text-lg font-bold text-gray-800 mb-1 line-clamp-1 group-hover:text-primary transition-all duration-300 text-shadow-sm hover:shadow-text">${song.title}</h3>
                                            <p class="text-sm text-gray-500 mb-3 transition-all duration-300 group-hover:text-gray-700">${song.composer || '未知作曲家'}</p>
                                            <div class="flex items-center mb-4">
                                                <div class="flex mr-3 transition-transform duration-300 group-hover:scale-105">
                                                    ${generateDifficultyStars(song.difficulty)}
                                                </div>
                                                <span class="text-xs text-gray-500 group-hover:text-primary transition-colors duration-300"><i class="fa fa-eye mr-1 transition-transform duration-300 group-hover:scale-110"></i>${song.views} 次浏览</span>
                                            </div>
                                            <a href="song-detail.html?id=${song.id}" class="block text-center mt-auto py-2 rounded-lg font-medium transition-all duration-300 ease-in-out relative overflow-hidden z-10" style="background: linear-gradient(135deg, rgba(26, 111, 196, 0.1) 0%, rgba(44, 62, 140, 0.1) 100%); color: #1a6fc4; box-shadow: 0 2px 8px rgba(26, 111, 196, 0.15);">
                                                <!-- 按钮渐变背景 -->
                                                <span class="relative z-10">查看详情</span>
                                                <span class="absolute inset-0 bg-gradient(135deg, #1a6fc4 0%, #2c3e8c 100%) opacity-0 hover:opacity-100 transition-opacity duration-300"></span>
                                                <span class="absolute bottom-0 left-0 w-full h-0.5 bg-white opacity-0 hover:opacity-100 transition-opacity duration-300"></span>
                                            </a>
                                        </div>
                                    </div>
                                `;
                                
                                // 添加卡片悬停时闪光动画的触发 - 修复选择器问题
                        songCard.addEventListener('mouseenter', function() {
                            // 使用明确的类选择器
                            const shine = this.querySelector('.shine-animation');
                            if (shine) {
                                shine.style.left = '125%';
                                setTimeout(() => {
                                    if (shine) shine.style.left = '-100%';
                                }, 750);
                            }
                        });
                         
                        // 添加鼠标离开时重置闪光位置
                        songCard.addEventListener('mouseleave', function() {
                            // 使用明确的类选择器
                            const shine = this.querySelector('.shine-animation');
                            if (shine) shine.style.left = '-100%';
                        });
                                  
                                // 添加卡片悬停效果
                                songCard.addEventListener('mouseenter', function() {
                                    this.style.transform = 'translateY(-8px)';
                                    this.style.boxShadow = '0 15px 40px rgba(0, 0, 0, 0.12)';
                                    this.style.borderColor = 'rgba(26, 111, 196, 0.2)';
                                });
                                  
                                songCard.addEventListener('mouseleave', function() {
                                    this.style.transform = '';
                                    this.style.boxShadow = '';
                                    this.style.borderColor = '';
                                });
                                  
                                songsContainer.appendChild(songCard);
                                // 确保使用正确的歌曲ID
                                const songId = song.id || '';
                                if (!songId) {
                                    console.warn('歌曲ID为空');
                                }
                                // 不再为每首歌曲单独初始化收藏按钮，改为批量处理
                            });
                            
                            // 批量初始化所有收藏按钮
                            initFavoriteButtons();
                        } catch (forEachError) {
                            console.error('曲目列表渲染错误:', forEachError);
                            songsContainer.innerHTML = `<div class="text-center text-red-500 col-span-full py-12">渲染错误: ${forEachError.message}</div>`;
                        }
                    }

                    // 更新结果统计
                    try {
                        if (data.data && data.data.currentPage !== undefined && data.data.pageSize !== undefined && data.data.totalItems !== undefined) {
                            const startIndex = (data.data.currentPage - 1) * data.data.pageSize + 1;
                            const endIndex = Math.min(startIndex + data.data.pageSize - 1, data.data.totalItems);
                            document.getElementById('result-count').textContent = `显示: ${startIndex}-${endIndex}，共 ${data.data.totalItems} 首曲目`;
                        } else {
                            // 使用filterState作为备选
                            const startIndex = (window.filterState.page - 1) * window.filterState.pageSize + 1;
                            const totalItems = data.data && data.data.totalItems ? data.data.totalItems : (data.data && data.data.items ? data.data.items.length : 0);
                            const endIndex = Math.min(startIndex + window.filterState.pageSize - 1, totalItems);
                            document.getElementById('result-count').textContent = `显示: ${startIndex}-${endIndex}，共 ${totalItems} 首曲目`;
                        }
                    } catch (summaryError) {
                        // 只保留错误日志
                        if (IS_DEVELOPMENT) {
                            console.error('结果统计更新错误:', summaryError);
                        }
                    }

                    // 生成分页控件
                    try {
                        if (data.data && data.data.totalPages !== undefined && data.data.currentPage !== undefined) {
                            renderPagination(data.data.totalPages, data.data.currentPage);
                        } else {
                            // 使用filterState和总条目数计算总页数
                            const totalItems = data.data && data.data.totalItems ? data.data.totalItems : (data.data && data.data.items ? data.data.items.length : 0);
                            const totalPages = Math.ceil(totalItems / window.filterState.pageSize);
                            renderPagination(totalPages, window.filterState.page);
                        }
                    } catch (paginationError) {
                        // 只保留错误日志
                        if (IS_DEVELOPMENT) {
                            console.error('分页控件渲染错误:', paginationError);
                        }
                    }
                } else {
                    // 只保留错误日志
                    if (IS_DEVELOPMENT) {
                        console.error('API返回失败:', data.message || '未知错误');
                    }
                    songsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-full py-12">加载失败，请稍后再试</div>';
                }
            } catch (error) {
                console.error('===== loadSongs函数全局错误捕获 =====');
                console.error('错误名称:', error.name);
                console.error('错误消息:', error.message);
                console.error('错误栈:', error.stack);
                console.error('当前时间:', new Date().toISOString());
                console.error('navigator.onLine:', navigator.onLine);
                
                // 只保留错误日志
                if (IS_DEVELOPMENT) {
                    console.error('加载曲目失败:', error);
                }
                
                const songsContainer = document.getElementById('songs-container');
                
                // 提供更友好的错误信息，区分不同类型的错误
                let errorMessage = '网络连接失败，请检查您的网络设置后重试';
                
                // 处理请求中止错误
                if (error.name === 'AbortError') {
                    errorMessage = '请求超时，请稍后再试';
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = '无法连接到服务器，请检查服务器是否正常运行';
                }
                
                // 在开发环境下显示原始错误信息以便调试
                if (IS_DEVELOPMENT) {
                    errorMessage += ` (${error.message})`;
                }
                
                // 添加更详细的错误信息
                const detailedErrorMessage = `${errorMessage}\n\n错误详情:\n- 错误类型: ${error.name}\n- 错误信息: ${error.message}\n- 请在浏览器控制台查看完整错误栈`;
                
                songsContainer.innerHTML = `<div class="text-center text-gray-500 col-span-full py-12">${detailedErrorMessage.replace(/\n/g, '<br>')}</div>`;
            }
        }

        // 批量初始化所有收藏按钮 - 优化版本，减少HTTP请求
        function initFavoriteButtons() {
            try {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`===== 开始批量初始化收藏按钮 =====`);
                }
                
                const favoriteButtons = document.querySelectorAll('.favorite-btn');
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`找到的收藏按钮数量: ${favoriteButtons.length}`);
                }
                
                // 为所有按钮设置默认状态并添加点击事件
                favoriteButtons.forEach(btn => {
                    // 设置默认未收藏状态
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.className = 'fa fa-heart-o text-primary text-sm';
                    }
                    
                    // 获取歌曲ID
                    const songId = btn.getAttribute('data-song-id');
                    if (!songId && IS_DEVELOPMENT) {
                        console.warn('收藏按钮缺少歌曲ID');
                    }
                    
                    // 添加点击事件处理
                    btn.addEventListener('click', handleFavoriteClick);
                });
                
                // 批量获取所有歌曲的收藏状态
                batchCheckFavoriteStatus();
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`收藏按钮批量初始化完成`);
                }
            } catch (error) {
                // 只保留错误日志
                if (IS_DEVELOPMENT) {
                    console.error(`批量初始化收藏按钮失败:`, error);
                }
            }
        }
        
        // 批量检查收藏状态 - 这是性能优化的核心，将多个请求合并为一个
        async function batchCheckFavoriteStatus() {
            try {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`开始批量检查收藏状态`);
                }
                
                const favoriteButtons = document.querySelectorAll('.favorite-btn');
                const songIds = Array.from(favoriteButtons).map(btn => btn.getAttribute('data-song-id')).filter(id => id);
                
                if (songIds.length === 0) {
                    // 生产环境移除调试日志
                    if (IS_DEVELOPMENT) {
                        console.log('没有需要检查收藏状态的歌曲');
                    }
                    return;
                }
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`需要检查的歌曲ID列表:`, songIds);
                }
                
                // 检查是否需要使用离线收藏模式
                const currentProtocol = window.location.protocol;
                const isFileProtocol = currentProtocol === 'file:';
                
                // 首先应用离线收藏状态（无论是否是file://协议）
                applyOfflineFavoriteStatuses(favoriteButtons);
                
                // 如果是file://协议，只使用离线收藏，不尝试从服务器获取
                if (isFileProtocol) {
                    // 生产环境移除调试日志
                    if (IS_DEVELOPMENT) {
                        console.log('使用file://协议，仅使用离线收藏状态');
                    }
                    return;
                }
                
                // 使用本地存储缓存的收藏状态（可选优化）
                const cachedFavorites = getCachedFavorites();
                
                // 先应用缓存的状态
                applyCachedFavoriteStatuses(favoriteButtons, cachedFavorites);
                
                // 然后从服务器获取最新状态
                try {
                    // 使用相对URL来避免端口号变化问题
                    const baseUrl = '/';
                    const apiUrl = `${baseUrl}/api/user/favorites`;
                    
                    const response = await fetch(apiUrl, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const favorites = await response.json();
                        
                        // 生产环境移除调试日志
                        if (IS_DEVELOPMENT) {
                            console.log(`获取到的收藏列表:`, favorites);
                        }
                        
                        // 更新本地存储
                        updateCachedFavorites(favorites);
                        
                        // 应用从服务器获取的最新状态
                        applyFavoriteStatuses(favoriteButtons, favorites);
                        
                        // 同时更新离线收藏，确保数据一致性
                        updateOfflineFavoritesFromServer(favorites);
                    } else {
                        // 如果获取所有收藏失败，尝试另一种方式
                        if (IS_DEVELOPMENT) {
                            console.warn(`获取所有收藏失败，状态码: ${response.status}`);
                        }
                        
                        // 备选方案：如果服务器没有提供批量API，我们仍然需要逐个检查
                        // 但使用更智能的方式 - 限制并发请求数
                        const BATCH_SIZE = 5; // 一次处理的请求数量
                        const batches = [];
                        for (let i = 0; i < songIds.length; i += BATCH_SIZE) {
                            batches.push(songIds.slice(i, i + BATCH_SIZE));
                        }
                        
                        // 逐个批次处理
                        for (const batch of batches) {
                            const promises = batch.map(songId => checkSingleFavoriteStatus(songId));
                            await Promise.allSettled(promises);
                            // 每个批次之间添加延迟，避免请求过于集中
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                } catch (error) {
                    if (IS_DEVELOPMENT) {
                        console.warn(`批量获取收藏状态失败，继续使用缓存和离线收藏状态:`, error);
                    }
                    
                    // 如果是网络错误，显示离线模式提示
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        showToast('网络连接不可用，当前使用离线收藏模式');
                        // 确保离线收藏状态正确应用
                        setTimeout(() => {
                            applyOfflineFavoriteStatuses(favoriteButtons);
                        }, 500);
                    } else {
                        // 备选方案：如果所有批量方式都失败，回退到逐个检查，但限制并发
                        const BATCH_SIZE = 3;
                        const batches = [];
                        for (let i = 0; i < songIds.length; i += BATCH_SIZE) {
                            batches.push(songIds.slice(i, i + BATCH_SIZE));
                        }
                        
                        // 逐个批次处理
                        for (const batch of batches) {
                            const promises = batch.map(songId => checkSingleFavoriteStatus(songId));
                            await Promise.allSettled(promises);
                            await new Promise(resolve => setTimeout(resolve, 150));
                        }
                    }
                }
            } catch (error) {
                if (IS_DEVELOPMENT) {
                    console.error(`批量检查收藏状态出错:`, error);
                }
            }
        }
        
        // 检查单个歌曲的收藏状态（用于回退方案）
        async function checkSingleFavoriteStatus(songId) {
            try {
                const baseUrl = '/';
                const apiUrl = `${baseUrl}/api/user/favorite/${songId}`;
                const response = await fetch(apiUrl, {
                    credentials: 'include',
                    timeout: 2000 // 设置超时，避免单个请求阻塞太久
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const btn = document.querySelector(`.favorite-btn[data-song-id="${songId}"]`);
                    if (btn) {
                        const icon = btn.querySelector('i');
                        if (icon) {
                            if (result.isFavorite) {
                                icon.className = 'fa fa-heart text-red-500 text-sm';
                                // 更新离线收藏
                                updateOfflineFavorites(songId, true);
                            } else {
                                icon.className = 'fa fa-heart-o text-primary text-sm';
                                // 更新离线收藏
                                updateOfflineFavorites(songId, false);
                            }
                        }
                    }
                }
            } catch (error) {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.warn(`获取歌曲 ${songId} 的收藏状态失败:`, error);
                }
                // 静默失败，不影响其他操作
                // 网络错误时，确保使用离线收藏状态
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    const btn = document.querySelector(`.favorite-btn[data-song-id="${songId}"]`);
                    if (btn) {
                        const offlineFavorites = getOfflineFavorites();
                        const isOfflineFavorite = offlineFavorites.some(fav => fav.id === songId);
                        const icon = btn.querySelector('i');
                        if (icon) {
                            if (isOfflineFavorite) {
                                icon.className = 'fa fa-heart text-red-500 text-sm';
                            } else {
                                icon.className = 'fa fa-heart-o text-primary text-sm';
                            }
                        }
                    }
                }
            }
        }
        
        // 从服务器更新离线收藏
        function updateOfflineFavoritesFromServer(serverFavorites) {
            try {
                if (!serverFavorites || (!Array.isArray(serverFavorites) && !serverFavorites.data)) return;
                
                // 处理不同格式的响应
                const favoritesArray = Array.isArray(serverFavorites) ? serverFavorites : 
                                      (serverFavorites.data && Array.isArray(serverFavorites.data)) ? serverFavorites.data : 
                                      [];
                
                // 获取现有的离线收藏
                const offlineFavorites = getOfflineFavorites();
                const offlineIds = new Set(offlineFavorites.map(fav => fav.id));
                
                // 创建服务器收藏ID的集合
                const serverIds = new Set(favoritesArray.map(fav => {
                    // 尝试不同的字段名获取歌曲ID
                    const idFields = ['songId', 'id', '_id'];
                    for (const field of idFields) {
                        if (fav[field]) {
                            return String(fav[field]);
                        }
                    }
                    return null;
                }).filter(id => id));
                
                // 找出只在离线收藏中存在的项目（可能是在离线模式下添加的）
                const offlineOnlyItems = offlineFavorites.filter(fav => !serverIds.has(fav.id));
                
                // 合并服务器收藏和离线独有的收藏
                const mergedFavorites = [];
                
                // 先添加服务器收藏
                favoritesArray.forEach(fav => {
                    // 尝试不同的字段名获取歌曲ID
                    let songId = null;
                    const idFields = ['songId', 'id', '_id'];
                    for (const field of idFields) {
                        if (fav[field]) {
                            songId = String(fav[field]);
                            break;
                        }
                    }
                    
                    if (songId) {
                        // 检查是否有离线收藏的详细信息
                        const offlineItem = offlineFavorites.find(item => item.id === songId);
                        if (offlineItem) {
                            // 合并信息，优先保留服务器数据
                            mergedFavorites.push({ ...offlineItem, ...fav });
                        } else {
                            mergedFavorites.push(fav);
                        }
                    }
                });
                
                // 再添加离线独有的收藏
                mergedFavorites.push(...offlineOnlyItems);
                
                // 保存合并后的收藏
                localStorage.setItem('offline_favorites', JSON.stringify(mergedFavorites));
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`从服务器更新离线收藏完成，共${mergedFavorites.length}项`);
                }
            } catch (error) {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.error('从服务器更新离线收藏失败:', error);
                }
            }
        }
        
        // 从本地存储获取缓存的收藏状态
        function getCachedFavorites() {
            try {
                const cached = localStorage.getItem('user_favorites');
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (error) {
                console.error('读取本地缓存失败:', error);
            }
            return [];
        }
        
        // 更新本地存储中的收藏状态缓存
        function updateCachedFavorites(favorites) {
            try {
                localStorage.setItem('user_favorites', JSON.stringify(favorites));
            } catch (error) {
                console.error('更新本地缓存失败:', error);
            }
        }
        
        // 应用缓存的收藏状态
        function applyCachedFavoriteStatuses(buttons, cachedFavorites) {
            try {
                if (!cachedFavorites || !Array.isArray(cachedFavorites)) return;
                
                const favoriteSongIds = new Set(cachedFavorites.map(fav => fav.songId?.toString() || fav.id?.toString()).filter(id => id));
                
                buttons.forEach(btn => {
                    const songId = btn.getAttribute('data-song-id');
                    const icon = btn.querySelector('i');
                    
                    if (songId && icon) {
                        if (favoriteSongIds.has(songId)) {
                            icon.className = 'fa fa-heart text-red-500 text-sm';
                        } else {
                            icon.className = 'fa fa-heart-o text-primary text-sm';
                        }
                    }
                });
            } catch (error) {
                console.error('应用缓存状态失败:', error);
            }
        }
        
        // 应用从服务器获取的收藏状态
        function applyFavoriteStatuses(buttons, favorites) {
            try {
                if (!favorites || (!Array.isArray(favorites) && !favorites.data)) return;
                
                // 处理不同格式的响应
                const favoritesArray = Array.isArray(favorites) ? favorites : 
                                      (favorites.data && Array.isArray(favorites.data)) ? favorites.data : 
                                      [];
                
                const favoriteSongIds = new Set(favoritesArray.map(fav => fav.songId?.toString() || fav.id?.toString()).filter(id => id));
                
                buttons.forEach(btn => {
                    const songId = btn.getAttribute('data-song-id');
                    const icon = btn.querySelector('i');
                    
                    if (songId && icon) {
                        if (favoriteSongIds.has(songId)) {
                            icon.className = 'fa fa-heart text-red-500 text-sm';
                        } else {
                            icon.className = 'fa fa-heart-o text-primary text-sm';
                        }
                    }
                });
            } catch (error) {
                console.error('应用收藏状态失败:', error);
            }
        }
        
        // 处理收藏按钮点击事件
        async function handleFavoriteClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const btn = this;
            
            // 防止重复点击
            if (btn.classList.contains('loading')) {
                return;
            }
            
            const songId = btn.getAttribute('data-song-id');
            const isCurrentlyFavorite = btn.querySelector('i').classList.contains('fa-heart');
            const newFavoriteState = !isCurrentlyFavorite;
            
            // 生产环境移除调试日志
            if (IS_DEVELOPMENT) {
                console.log(`点击收藏按钮: songId=${songId}, 当前状态=${isCurrentlyFavorite}, 目标状态=${newFavoriteState}`);
            }
            
            // 显示加载状态
            btn.disabled = true;
            btn.classList.add('loading');
            const icon = btn.querySelector('i');
            icon.className = 'fa fa-spinner fa-spin text-primary text-sm';
            
            try {
                // 使用明确的服务器地址，避免直接从文件系统访问时的问题
                // 使用与服务器相同的端口
    const port = window.location.port || '3004';
    const baseUrl = `http://localhost:${port}`;
                const apiUrl = `${baseUrl}/api/user/favorite`;
                
                // 获取当前曲目信息，用于离线收藏
                const songCard = btn.closest('.song-card');
                const songInfo = {
                    id: songId,
                    title: songCard.querySelector('h3')?.textContent || '未知曲目',
                    type: songCard.querySelector('.text-xs.text-gray-500')?.textContent || '未知类型',
                    difficulty: songCard.getAttribute('data-difficulty') || '0',
                    image: songCard.querySelector('img')?.src || ''
                };
                
                // 标记是否为离线模式
                let isOfflineMode = false;
                
                // 首先尝试通过API保存（如果不是file://协议）
                if (currentProtocol !== 'file:') {
                    try {
                        // 生产环境移除调试日志
                        if (IS_DEVELOPMENT) {
                            console.log(`发送收藏请求到: ${apiUrl}`);
                            console.log(`请求数据:`, { songId, isFavorite: newFavoriteState });
                        }
                        
                        // 发送请求
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ songId, isFavorite: newFavoriteState }),
                            credentials: 'include', // 确保包含cookie
                            timeout: 5000 // 设置超时时间
                        });
                        
                        // 生产环境移除调试日志
                        if (IS_DEVELOPMENT) {
                            console.log(`API响应状态: ${response.status} ${response.statusText}`);
                        }
                        
                        // 增强的错误处理
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error('该歌曲不存在或已被删除');
                            } else if (response.status === 401) {
                                throw new Error('请先登录后再收藏');
                            } else if (response.status === 429) {
                                throw new Error('操作过于频繁，请稍后再试');
                            } else {
                                throw new Error(`服务器错误，请稍后重试`);
                            }
                        }
                        
                        // 尝试解析响应
                        let data;
                        try {
                            data = await response.json();
                            // 生产环境移除调试日志
                            if (IS_DEVELOPMENT) {
                                console.log(`API响应数据:`, data);
                            }
                        } catch (jsonError) {
                            // 生产环境移除调试日志
                            if (IS_DEVELOPMENT) {
                                console.error('JSON解析错误:', jsonError);
                            }
                            throw new Error('服务器响应格式错误');
                        }
                        
                        // API调用成功，更新本地缓存
                        updateOfflineFavorites(songId, newFavoriteState, songInfo);
                        
                    } catch (apiError) {
                        // 生产环境移除调试日志
                        if (IS_DEVELOPMENT) {
                            console.warn(`API调用失败，切换到离线模式:`, apiError);
                        }
                        isOfflineMode = true;
                        
                        // 检查是否是网络错误
                        if (apiError.name === 'TypeError' && apiError.message.includes('Failed to fetch')) {
                            // 网络错误，直接使用离线模式
                            updateOfflineFavorites(songId, newFavoriteState, songInfo);
                        } else {
                            // 其他API错误，抛出异常
                            throw apiError;
                        }
                    }
                } else {
                    // file://协议，直接使用离线模式
                    isOfflineMode = true;
                    updateOfflineFavorites(songId, newFavoriteState, songInfo);
                }
                
                // 更新按钮状态
                if (newFavoriteState) {
                    icon.className = 'fa fa-heart text-red-500 text-sm';
                    showToast(isOfflineMode ? '已添加到离线收藏' : '收藏成功');
                } else {
                    icon.className = 'fa fa-heart-o text-primary text-sm';
                    showToast(isOfflineMode ? '已取消离线收藏' : '已取消收藏');
                }
                
                // 重新获取所有收藏以更新缓存
                setTimeout(() => {
                    batchCheckFavoriteStatus();
                }, 1000);
                
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`收藏操作成功完成${isOfflineMode ? '（离线模式）' : ''}`);
                }
                
            } catch (error) {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.error(`收藏操作失败:`, error);
                }
                
                // 特殊错误处理
                let errorMessage = error.message || '操作失败，请稍后重试';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = '网络连接错误，请检查您的网络连接或服务器是否正常运行';
                }
                
                // 恢复原状态
                if (isCurrentlyFavorite) {
                    icon.className = 'fa fa-heart text-red-500 text-sm';
                } else {
                    icon.className = 'fa fa-heart-o text-primary text-sm';
                }
                
                // 显示详细的错误信息
                showToast(errorMessage);
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`===== 收藏操作完成 =====`);
                }
            }
        }
        
        // 更新离线收藏状态
        function updateOfflineFavorites(songId, isFavorite, songInfo = null) {
            try {
                // 获取现有的离线收藏
                const offlineFavorites = getOfflineFavorites();
                
                if (isFavorite) {
                    // 添加到离线收藏
                    const existingIndex = offlineFavorites.findIndex(fav => fav.id === songId);
                    if (existingIndex >= 0) {
                        // 如果已存在，更新信息
                        if (songInfo) {
                            offlineFavorites[existingIndex] = { ...offlineFavorites[existingIndex], ...songInfo };
                        }
                    } else {
                        // 如果不存在，添加新收藏
                        const favoriteItem = songInfo ? { ...songInfo } : { id: songId, title: '未知曲目' };
                        favoriteItem.addedAt = new Date().toISOString();
                        offlineFavorites.push(favoriteItem);
                    }
                } else {
                    // 从离线收藏中移除
                    const filteredFavorites = offlineFavorites.filter(fav => fav.id !== songId);
                    localStorage.setItem('offline_favorites', JSON.stringify(filteredFavorites));
                    return;
                }
                
                // 保存更新后的离线收藏
                localStorage.setItem('offline_favorites', JSON.stringify(offlineFavorites));
                console.log(`离线收藏已更新:`, songId, isFavorite);
            } catch (error) {
                console.error('更新离线收藏失败:', error);
            }
        }
        
        // 获取离线收藏
        function getOfflineFavorites() {
            try {
                const cached = localStorage.getItem('offline_favorites');
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (error) {
                console.error('读取离线收藏失败:', error);
            }
            return [];
        }
        
        // 应用离线收藏状态
        function applyOfflineFavoriteStatuses(buttons) {
            try {
                const offlineFavorites = getOfflineFavorites();
                const favoriteSongIds = new Set(offlineFavorites.map(fav => fav.id?.toString()).filter(id => id));
                
                buttons.forEach(btn => {
                    const songId = btn.getAttribute('data-song-id');
                    const icon = btn.querySelector('i');
                    
                    if (songId && icon) {
                        if (favoriteSongIds.has(songId)) {
                            icon.className = 'fa fa-heart text-red-500 text-sm';
                        } else {
                            icon.className = 'fa fa-heart-o text-primary text-sm';
                        }
                    }
                });
            } catch (error) {
                console.error('应用离线收藏状态失败:', error);
            }
        }
        
        // 从服务器更新离线收藏
        function updateOfflineFavoritesFromServer(serverFavorites) {
            try {
                if (!serverFavorites || (!Array.isArray(serverFavorites) && !serverFavorites.data)) return;
                
                // 处理不同格式的响应
                const favoritesArray = Array.isArray(serverFavorites) ? serverFavorites : 
                                      (serverFavorites.data && Array.isArray(serverFavorites.data)) ? serverFavorites.data : 
                                      [];
                
                // 获取现有的离线收藏
                const offlineFavorites = getOfflineFavorites();
                const offlineIds = new Set(offlineFavorites.map(fav => fav.id));
                
                // 创建服务器收藏ID的集合
                const serverIds = new Set(favoritesArray.map(fav => {
                    // 尝试不同的字段名获取歌曲ID
                    const idFields = ['songId', 'id', '_id'];
                    for (const field of idFields) {
                        if (fav[field]) {
                            return String(fav[field]);
                        }
                    }
                    return null;
                }).filter(id => id));
                
                // 找出只在离线收藏中存在的项目（可能是在离线模式下添加的）
                const offlineOnlyItems = offlineFavorites.filter(fav => !serverIds.has(fav.id));
                
                // 合并服务器收藏和离线独有的收藏
                const mergedFavorites = [];
                
                // 先添加服务器收藏
                favoritesArray.forEach(fav => {
                    // 尝试不同的字段名获取歌曲ID
                    let songId = null;
                    const idFields = ['songId', 'id', '_id'];
                    for (const field of idFields) {
                        if (fav[field]) {
                            songId = String(fav[field]);
                            break;
                        }
                    }
                    
                    if (songId) {
                        // 检查是否有离线收藏的详细信息
                        const offlineItem = offlineFavorites.find(item => item.id === songId);
                        if (offlineItem) {
                            // 合并信息，优先保留服务器数据
                            mergedFavorites.push({ ...offlineItem, ...fav });
                        } else {
                            mergedFavorites.push(fav);
                        }
                    }
                });
                
                // 再添加离线独有的收藏
                mergedFavorites.push(...offlineOnlyItems);
                
                // 保存合并后的收藏
                localStorage.setItem('offline_favorites', JSON.stringify(mergedFavorites));
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.log(`从服务器更新离线收藏完成，共${mergedFavorites.length}项`);
                }
            } catch (error) {
                // 生产环境移除调试日志
                if (IS_DEVELOPMENT) {
                    console.error('从服务器更新离线收藏失败:', error);
                }
            }
        }
        
        // 显示提示信息
        function showToast(message) {
            // 检查是否已存在toast元素
            let toast = document.querySelector('.toast-message');
            if (toast) {
                clearTimeout(toast.timeout);
                document.body.removeChild(toast);
            }
            
            // 创建新的toast元素
            toast = document.createElement('div');
            toast.className = 'toast-message fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // 自动隐藏
            toast.timeout = setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // 为了兼容admin.html中的代码，添加showNotification函数实现
        function showNotification(type, title, message) {
            // type: success, error, warning, info
            let icon = 'fa-info-circle';
            let prefix = '';
            
            switch(type) {
                case 'success':
                    icon = 'fa-check-circle';
                    prefix = '成功: ';
                    break;
                case 'error':
                    icon = 'fa-times-circle';
                    prefix = '错误: ';
                    break;
                case 'warning':
                    icon = 'fa-exclamation-circle';
                    prefix = '警告: ';
                    break;
                case 'info':
                default:
                    icon = 'fa-info-circle';
                    prefix = '信息: ';
                    break;
            }
            
            // 如果只有一个参数，可能是直接调用showNotification(message)
            if (arguments.length === 1) {
                showToast(arguments[0]);
            } else {
                // 组合标题和消息
                const fullMessage = `${prefix}${title || ''}${message ? ': ' + message : ''}`;
                showToast(fullMessage);
            }
        }
        

        
        // 页面加载完成后执行
        window.addEventListener('DOMContentLoaded', () => {
            initFilterButtons();
            loadSongs();
        });
    </script>
    
    <!-- 性能优化脚本 -->
    <script src="performance-optimization.js"></script>
</body>
</html>
